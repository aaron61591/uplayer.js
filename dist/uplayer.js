"use strict";!function(){function a(a,b){a.canvas=j._canvas(),a.$canvas=j._canvas(),a.ctx=a.canvas.getContext("2d"),a.$ctx=a.$canvas.getContext("2d"),a.opt=b||{},a.canvas.id=a.opt.id||"",a.plugins=a.opt.debug?[j.debug]:[],a.pluginsIndex={},a.curFrame=0,a.playing=!1}function b(a){var b=a.style;b.position="fixed",b.top=0,b.left=0,b.zIndex=1e3,c(a),window.onresize=function(){c(a)}}function c(a){a.width=window.innerWidth,a.height=window.innerHeight}function d(a,b){for(var c in a.pluginsIndex)a.pluginsIndex.hasOwnProperty(c)&&a.pluginsIndex[c]>=b&&++a.pluginsIndex[c]}function e(a,b){for(var c in a.pluginsIndex)a.pluginsIndex.hasOwnProperty(c)&&a.pluginsIndex[c]>=b&&++a.pluginsIndex[c]}function f(a,b,c){a.plugins.splice(c,1),a.pluginsIndex[b]=void 0,e(a,c)}function g(a,b,c){var d=+new Date;a.playing&&(d-b>1e3/(a.opt.fps||30)&&(UPlayer._render(a),++a.curFrame,b=d,void 0!==c&&--c),void 0===c||c?i.call(window,function(){g(a,b,c)}):a.playing=!1)}function h(a){for(var b=a.length,c=0;b--;)a[b]>c&&(c=a[b]);return c+1}var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.setTimeout,j=window.UPlayer=function(c){var d=this;a(d,c),(void 0===d.opt.fullScreen||d.opt.fullScreen)&&(b(d.canvas),b(d.$canvas),document.body.appendChild(d.canvas))};j.prototype.plug=function(a){var b=0;for(a.zIndex=a.zIndex||0,a.$hash=UPlayer._uuid();b<this.plugins.length&&!(a.zIndex<this.plugins[b].zIndex);)++b;if(this.plugins.splice(b,0,a),void 0!==a.id){var c=this.pluginsIndex[a.id];void 0!==c?"object"==typeof c?c.push(b):this.pluginsIndex[a.id]=[c,b]:(d(this,b),this.pluginsIndex[a.id]=b)}},j.prototype.plugCard=function(a){var b=this;j.preImage(a.src,function(c){a.img=c,a.card=!0,a.render=function(b,d){a.pulse&&a.pulse(b,d);var e,f,g,i=a.scaleX||a.scale||1,j=a.scaleY||a.scale||1;"object"==typeof a.frame?(f=h(a.frame),e=a.frame[d%a.frame.length]):(f=a.frame,e=d%f),g=c.width/f,b.drawImage(c,e*g,0,g,c.height,a.x||0,a.y||0,g*i,c.height*j)},b.plug(a)})},j.prototype.unplug=function(a){var b=this.pluginsIndex[a];if(void 0!==b)if("object"!=typeof b)f(this,a,b);else for(var c=b.length;c--;)f(this,a,b[c])},j.prototype.run=function(a){if(!this.playing){this.playing=!0;var b=this;window.UPlayer._imageReady(function(){g(b,0,a)})}},j.prototype.pause=function(){this.playing=!1},j.prototype.stop=function(){this.curFrame=0,this.playing=!1}}(),function(){function a(a,b){a.clearRect(0,0,f(b),g(b))}function b(a,b){c(a,b)?e(a,b):d(a,b)}function c(a,b){return b.frame&&!b.card&&a.opt.performance!==!1&&-1===n.indexOf(h(a,b))}function d(a,b){"function"==typeof b?b(a.ctx,a.curFrame):"function"==typeof b.render&&b.render(a.ctx,a.curFrame)}function e(b,c){var e,f,g,i,p=o[h(b,c)],q=[],r=3,s=0,t=0,u=b.$canvas.width,v=b.$canvas.height;if(!p){if(m)return void d(b,c);for(a(b.$ctx,b),c.render(b.$ctx,b.curFrame),q=b.$ctx.getImageData(0,0,u,v).data;r<q.length;)q[r]&&(s=(r-3)/4%u,t=parseInt(r/4/u,10),void 0===e?(e=g=s,f=i=t):(e>s&&(e=s),f>t&&(f=t),s>g&&(g=s),t>i&&(i=t))),r+=4;var w=new Image,x=g-e+1,y=i-f+1,z=document.createElement("canvas"),A=z.getContext("2d");if(!(j-l>x*y))return m=!0,d(b,c),void alert("full");if(!(k>x*y))return d(b,c),void n.push(h(b,c));l+=x*y,z.width=x,z.height=y,A.drawImage(b.$canvas,e,f,x,y,0,0,x,y),w.src=z.toDataURL(),o[h(b,c)]=p={x:e,y:f,img:w}}b.ctx.drawImage(p.img,p.x,p.y)}function f(a){return a.canvas.width}function g(a){return a.canvas.height}function h(a,b){return b.$hash+a.curFrame%b.frame}var i=window.UPlayer,j=45705600,k=152352,l=0,m=!1,n=[],o={};i._render=function(c){(c.opt.refresh||void 0===c.opt.refresh)&&a(c.ctx,c);for(var d=0;d<c.plugins.length;)c.plugins[d]=c.plugins[d]||{},b(c,c.plugins[d]),++d},i._clearCache=function(){}}(),function(){function a(a,b){if(f[a])f[a].push(b);else{++e,f[a]=[b];var d=new Image;d.src=a,d.complete?c(d,a):d.onload=function(){c(d,a)}}}function b(){for(var a=0;a<g.length;)g[a](),++a}function c(a,c){--e||b(),d[c]=a;for(var g=0;g<f[c].length;)f[c][g](a),++g;f[c]=null}var d={},e=0,f={},g=[];window.UPlayer.preImage=function(b,c){var e=d[b];e?c(e):a(b,c)},window.UPlayer._imageReady=function(a){e?g.push(a):a()}}(),function(){function a(){if(!f){var a=document.createElement("div"),b=a.style;a.id=g,b.position="fixed",b.top=0,b.right=0,b.zIndex=1e4,b.fontSize="24px",b.color="#fff",b.margin="5px",b.padding="10px",b.background="rgba(0, 0, 0, 0.6)",a.innerText="FPS 0",document.body.appendChild(a),f=!0}}var b,c=+new Date,d=10,e=0,f=!1,g="uplayer-fps";window.UPlayer.debug=function(){a(),++e%d===0&&(b=+new Date,document.getElementById(g).innerText="FPS "+(d/((b-c)/1e3)).toFixed(1),c=b)}}(),function(){var a=window.UPlayer;a._uuid=function(){for(var a=[],b="0123456789abcdef",c=0;36>c;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);return a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-",a.join("")},a._canvas=function(){return document.createElement("canvas")}}();